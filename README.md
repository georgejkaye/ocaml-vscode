# Scripts to use with OCaml and VS Code

## Prerequisites

You will need [OPAM](https://opam.ocaml.org/), the OCaml package manager.
I would recommend downloading the [latest binary](https://opam.ocaml.org/doc/Install.html#Binary-distribution) as the version in your package manager can be quite outdated!

To get started with OPAM, just run

```bash
opam init
opam switch create 4.12.0
```

(you can substitute `4.12.0` for whichever is the most recent version of OCaml)

You will need the following OPAM packages:

* `merlin` - This will provide linting information in your files
* `ocamlfind` This makes it easier to build multi-file projects

You can install these easily with one command:

```bash
opam install merlin ocamlfind
```

The recommended VS code extension is the [OCaml and Reason IDE](https://marketplace.visualstudio.com/items?itemName=freebroccolo.reasonml).

In your `settings.json` (press `Ctrl+Shift+P` and type `settings`), you will need to tell VS Code where to find `ocamlfind` and `merlin`.
You can find this out by typing `which ocamlfind` and `which ocamlmerlin` into your terminal.

```json
  "reason.path.ocamlfind": "/home/george/.opam/4.12.0/bin/ocamlfind",
  "reason.path.ocamlmerlin": "/home/george/.opam/4.12.0/bin/ocamlmerlin",
  "reason.codelens.enabled": true,
```

## Setting up `.merlin`

For Merlin to work correctly, a `.merlin` file is required at the root of the project.
This contains details of the packages, built files and source files used in the project.

### Package files

External packages must be declared with a `PKG <package>` line in the `.merlin` file.
The package name should be all in lowercase: you can check the package name is correct by running `ocamlfind query <package>`.

For example, for Merlin to be able to detect the packages in the following source file:

```ocaml
open Base
open Stdio

(* code *)
```

the following lines are required in the `.merlin` file:

```merlin
PKG base
PKG stdio
```

### Build and source files

You must also declare to Merlin the location of your source and build files.
This allows Merlin to identify modules and values declared in other files in your project.
A typical declaration looks like this:

```merlin
B _build/**
S src/**
```

The `_build` folder is generally the standard for all OCaml projects, including those build with more sophisticated tools such as Dune.

### Multiple directories

If your project has source files across multiple directories that depend on each other, then you will need to 

For example, in the following file structure:

```bash
src
|-- Foo
    |-- A.ml
    |-- B.ml
|-- Bar
    |-- C.ml
```

if we want `C.ml` to be able to see the modules in `Foo`, then we will need the following `ocamlbuild` plugin:

```ocaml
open Ocamlbuild_plugin
 
let () =
  dispatch begin function
  | After_rules ->
     Pathname.define_context "src/Bar" ["src/Foo"]
  | _ -> ()
  end
```

You will need to also add the `ocamlbuild_plugin` package to your `.merlin`.

```merlin
PKG ocamlbuild_plugin
```

## Scripts

### `compile.sh`

**Usage:** `./compile.sh <module name> <relative module path>`
**Example:** `./compile.sh A src`

Uses `ocamlbuild` to build a native code executable and associated files. 
In particular, this generates `.cmi` files, which are used by Merlin to detect modules and functions outside of the current file.
Otherwise, you will simply get an `Unbound module` or `Unbound value` error along with plenty of red squiggles.

### `run.sh`

**Usage:** `./run.sh <module name> <relative module path>`
**Example:** `./run.sh A src`

Runs an executable generated by the compile script.
This is just a wrapper that makes it a little bit easier to run executables buried in the `_build` folder.

## VS Code tasks

You can add the scripts as VS Code tasks to speed up development.
Just put the following in your project's `.vscode/tasks.json`:

```json
{
  "version": "2.0.0",
  "tasks": [
    {
      "label": "Compile ocaml",
      "type": "shell",
      "command": [
        "./compile.sh",
        "${fileBasenameNoExtension}",
        "${relativeFileDirname}"
      ],
      "group": {
        "kind": "build",
        "isDefault": true
      }
    },
    {
      "label": "Run ocaml",
      "type": "shell",
      "command": [
        "./run.sh",
        "${fileBasenameNoExtension}",
        "${relativeFileDirname}"
      ],
      "problemMatcher": []
    }
  ]
}
```

The `isDefault:true` line marks the `Compile ocaml` script as the default build task: this means you can run it at any time by pressing `Ctrl+Shift+B`.
To run other tasks you can press `Ctrl+Shift+R` and select from the drop-down list.
